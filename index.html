<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXegIgxvYuUiHgQBgJIvIexndD6QYUi-UKz0lGem04RYDLkOo3OmdXNME1e63A3g/pub?output=csv";

let DATA = {};
let cart = [];
let currentProductType = '';
let currentSelection = {};

const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modal-title');
const dynamicFields = document.getElementById('dynamic-fields');
const modalPriceDisplay = document.getElementById('modal-price');
const btnAdd = document.getElementById('btn-add-cart');
const cartFloat = document.getElementById('cart-float');
const cartCount = document.getElementById('cart-count');
const cartTotal = document.getElementById('cart-total');

const WA_NUMBER = "5491153196358";

/* =====================
   CARGA CSV
===================== */
fetch(CSV_URL)
  .then(res => res.text())
  .then(text => parseCSV(text));

function parseCSV(text) {
    const rows = text.split("\n").slice(1);
    rows.forEach(r => {
        const [producto, categoria, nombre, precio] = r.split(",");
        if (!producto || !categoria) return;

        if (!DATA[producto]) DATA[producto] = {};
        if (!DATA[producto][categoria]) DATA[producto][categoria] = [];

        DATA[producto][categoria].push({
            name: nombre,
            price: parseInt(precio) || 0
        });
    });
}

/* =====================
   MODAL
===================== */
function openModal(type) {
    currentProductType = type;
    renderFields(type);
    updatePrice();
    modal.classList.add('active');
}

function closeModal() {
    modal.classList.remove('active');
}

function renderFields(type) {
    let html = '';

    const createSelect = (label, id, options) => `
        <div class="form-group">
            <label class="form-label">${label}</label>
            <div class="select-wrapper">
                <select id="${id}" onchange="updatePrice()">
                    <option value="0">Seleccionar...</option>
                    ${options.map(o =>
                        `<option value="${o.price}" data-name="${o.name}">${o.name}</option>`
                    ).join("")}
                </select>
            </div>
        </div>
    `;

    if (type === 'profesores') {
        modalTitle.innerText = "Configurar Calificador Profesores";
        html += createSelect("Cursos", "sel-base", DATA.profesores.cursos);
        html += createSelect("Tema", "sel-tema", DATA.comunes.temas);
        html += createSelect("Librería", "sel-lib", DATA.comunes.libreria);
        html += createSelect("Adicionales", "sel-add", DATA.comunes.adicionales);
        html += createSelect("Digital", "sel-dig", DATA.digitales.formato);
    }

    if (type === 'maestros') {
        modalTitle.innerText = "Configurar Calificador Maestrxs";
        html += createSelect("Grados", "sel-base", DATA.maestros.grados);
        html += createSelect("Tema", "sel-tema", DATA.comunes.temas);
        html += createSelect("Librería", "sel-lib", DATA.comunes.libreria);
        html += createSelect("Adicionales", "sel-add", DATA.comunes.adicionales);
        html += createSelect("Digital", "sel-dig", DATA.digitales.formato);
    }

    if (type === 'digital') {
        modalTitle.innerText = "Calificador Digital";
        html += createSelect("Formato", "sel-base", DATA.digitales.formato);
    }

    dynamicFields.innerHTML = html;
}

/* =====================
   PRECIOS
===================== */
function updatePrice() {
    const selects = dynamicFields.querySelectorAll("select");
    let total = 0;
    let valid = true;
    let details = [];

    selects.forEach(sel => {
        const price = parseInt(sel.value);
        const name = sel.options[sel.selectedIndex]?.dataset.name;

        if (sel.id === "sel-base" && price === 0) valid = false;
        total += price;
        if (name) details.push(name);
    });

    modalPriceDisplay.innerText = `$${total.toLocaleString("es-AR")}`;
    btnAdd.disabled = !valid;

    currentSelection = { price: total, details };
}

/* =====================
   CARRITO
===================== */
function addToCart() {
    if (btnAdd.disabled) return;

    cart.push({
        product: currentProductType,
        details: currentSelection.details,
        price: currentSelection.price
    });

    closeModal();
    updateCartUI();
}

function updateCartUI() {
    if (!cart.length) return cartFloat.classList.add("hidden");

    cartFloat.classList.remove("hidden");
    const total = cart.reduce((s, i) => s + i.price, 0);

    cartCount.innerText = `${cart.length} ítems`;
    cartTotal.innerText = `Total: $${total.toLocaleString("es-AR")}`;
}

function checkout() {
    let msg = "Hola! Quiero el siguiente pedido:\n\n";
    let total = 0;

    cart.forEach((i, n) => {
        msg += `${n+1}. ${i.product}\n`;
        i.details.forEach(d => msg += `- ${d}\n`);
        msg += `Precio: $${i.price}\n\n`;
        total += i.price;
    });

    msg += `TOTAL: $${total.toLocaleString("es-AR")}`;

    window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(msg)}`);
}

window.onclick = e => { if (e.target == modal) closeModal(); }
</script>
